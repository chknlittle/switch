flowchart LR
  %% Session message flow (readable on GitHub)

  User["User XMPP Client"]
  XMPP["ejabberd (XMPP)"]

  subgraph Orchestrators["Orchestrators"]
    direction TB
    Dispatcher["DispatcherBot\n(src/bots/dispatcher.py)"]
    Manager["SessionManager\n(src/manager.py)"]
    Lifecycle["create/kill\n(src/lifecycle/sessions.py)"]
  end

  subgraph Session["One Session"]
    direction TB
    SessionBot["SessionBot\n(src/bots/session/bot.py)"]
    Inbound["Inbound parse\n(inbound.py)"]
    Typing["Typing keepalive\n(typing.py)"]
    Actor["[Q] SessionActor\n(queue + serialize)\n(actor.py)"]
    Cancel["[X] cancel_operations\n(drop queue + cancel runner)"]
  end

  subgraph Runners["Runners"]
    direction TB
    Registry["create_runner\n(src/runners/registry.py)"]
    Ports["Runner port\n(run + cancel)\n(src/runners/ports.py)"]
    Claude["ClaudeRunner\n(local claude CLI)"]
    OpenCode["OpenCodeRunner\n(server API)"]
  end

  subgraph Storage["Storage"]
    direction TB
    DB["sessions.db\n(src/db.py repos)"]
    AttStore["AttachmentStore\n(src/attachments/store.py)"]
    AttHTTP["Attachments server\n(src/attachments/server.py)"]
  end

  OpenCodeSrv["External OpenCode server"]

  %% XMPP edges
  User <--> XMPP
  XMPP -->|"orchestrator msg"| Dispatcher
  Dispatcher --> Manager --> Lifecycle --> DB

  XMPP -->|"session msg"| SessionBot
  SessionBot --> Inbound
  SessionBot --> Typing
  SessionBot -->|enqueue| Actor
  SessionBot -->|persist| DB

  %% Attachments
  SessionBot -->|download URLs| AttStore -->|serve| AttHTTP

  %% Runner selection
  Actor -->|dequeue 1| Registry --> Ports
  Ports -->|engine=claude| Claude
  Ports -->|engine=opencode| OpenCode
  OpenCode <--> |HTTP + SSE| OpenCodeSrv

  %% Streaming back
  Claude -->|events: tool/text/result| SessionBot
  OpenCode -->|events: tool/text/question/result| SessionBot

  %% Cancellation
  SessionBot -.-> Cancel
  Cancel -.->|drop queued| Actor
  Cancel -.->|Runner cancel| Ports

  classDef cancel stroke:#b00020,stroke-width:2px,fill:#fff5f6,color:#111;
  class Cancel,Actor cancel;
